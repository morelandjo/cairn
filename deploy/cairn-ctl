#!/usr/bin/env bash
set -euo pipefail

# cairn-ctl — Operator CLI for Cairn
# Usage: cairn-ctl <command> [args]

DEPLOY_DIR="${CAIRN_DIR:-/opt/cairn}"
COMPOSE="docker compose"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

cd "$DEPLOY_DIR" 2>/dev/null || {
  echo -e "${RED}Error:${NC} Deploy directory not found: $DEPLOY_DIR"
  echo "Set CAIRN_DIR or install Cairn first."
  exit 1
}

cmd_status() {
  echo -e "${GREEN}Cairn Status${NC}"
  echo "─────────────────────────────────"
  $COMPOSE ps
  echo ""

  # Health check
  local port
  port=$(grep SERVER_PORT .env 2>/dev/null | cut -d= -f2)
  port=${port:-4000}
  if curl -sf "http://localhost:${port}/health" &>/dev/null; then
    echo -e "Health: ${GREEN}OK${NC}"
  else
    echo -e "Health: ${RED}UNHEALTHY${NC}"
  fi

  # Version
  echo "Deploy dir: $DEPLOY_DIR"
}

cmd_logs() {
  local service="${1:-}"
  if [ -n "$service" ]; then
    $COMPOSE logs -f "$service"
  else
    $COMPOSE logs -f
  fi
}

cmd_upgrade() {
  echo -e "${GREEN}Upgrading Cairn...${NC}"

  # Pre-upgrade backup
  echo "Creating pre-upgrade backup..."
  cmd_backup

  # Pull new images
  echo "Pulling latest images..."
  $COMPOSE pull

  # Restart server (rolling)
  echo "Restarting server..."
  $COMPOSE up -d --no-deps server

  # Wait for health
  local port
  port=$(grep SERVER_PORT .env 2>/dev/null | cut -d= -f2)
  port=${port:-4000}
  echo "Waiting for server health..."
  for i in $(seq 1 30); do
    if curl -sf "http://localhost:${port}/health" &>/dev/null; then
      break
    fi
    sleep 2
  done

  # Run migrations
  echo "Running migrations..."
  $COMPOSE exec -T server bin/cairn eval "Cairn.Release.migrate()"

  # Restart SFU
  echo "Restarting SFU..."
  $COMPOSE up -d --no-deps sfu

  echo -e "${GREEN}Upgrade complete.${NC}"
  cmd_status
}

cmd_rollback() {
  echo -e "${YELLOW}Rolling back Cairn...${NC}"

  # Find latest backup
  local latest_backup
  latest_backup=$(ls -1td "$DEPLOY_DIR/backups"/cairn-backup-* 2>/dev/null | head -1)

  if [ -z "$latest_backup" ]; then
    echo -e "${RED}No backup found to rollback to.${NC}"
    exit 1
  fi

  echo "Rolling back to: $latest_backup"
  read -rp "Are you sure? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy] ]]; then
    echo "Cancelled."
    exit 0
  fi

  # Restore database
  if [ -f "$latest_backup/database.pgdump" ]; then
    echo "Restoring database..."
    $COMPOSE exec -T postgres pg_restore \
      -U cairn -d cairn --clean --if-exists \
      < "$latest_backup/database.pgdump" || true
  fi

  # Restart services
  $COMPOSE restart
  echo -e "${GREEN}Rollback complete.${NC}"
}

cmd_backup() {
  local backup_name="cairn-backup-$(date +%Y%m%d-%H%M%S)"
  local backup_dir="$DEPLOY_DIR/backups/$backup_name"
  mkdir -p "$backup_dir"

  echo "Creating backup: $backup_name"

  # Database dump
  $COMPOSE exec -T postgres pg_dump -U cairn -Fc cairn > "$backup_dir/database.pgdump" 2>/dev/null
  echo "  Database: OK"

  # Uploads
  $COMPOSE exec -T server tar czf - /app/priv/uploads > "$backup_dir/uploads.tar.gz" 2>/dev/null || true
  echo "  Uploads: OK"

  # Keys
  $COMPOSE exec -T server tar czf - /app/priv/keys > "$backup_dir/keys.tar.gz" 2>/dev/null || true
  echo "  Keys: OK"

  echo -e "${GREEN}Backup saved: $backup_dir${NC}"
}

cmd_restore() {
  local backup_path="${1:-}"
  if [ -z "$backup_path" ]; then
    echo "Usage: cairn-ctl restore /path/to/backup"
    exit 1
  fi

  if [ ! -d "$backup_path" ]; then
    echo -e "${RED}Backup not found: $backup_path${NC}"
    exit 1
  fi

  echo "Restoring from: $backup_path"
  read -rp "This will overwrite the current database. Continue? (y/N): " confirm
  if [[ ! "$confirm" =~ ^[Yy] ]]; then
    echo "Cancelled."
    exit 0
  fi

  if [ -f "$backup_path/database.pgdump" ]; then
    echo "Restoring database..."
    $COMPOSE exec -T postgres pg_restore \
      -U cairn -d cairn --clean --if-exists \
      < "$backup_path/database.pgdump" || true
  fi

  echo -e "${GREEN}Restore complete. Restart services: cairn-ctl restart${NC}"
}

cmd_restart() {
  echo "Restarting all services..."
  $COMPOSE up -d --force-recreate
  cmd_status
}

cmd_stop() {
  echo "Stopping all services..."
  $COMPOSE stop
}

cmd_start() {
  echo "Starting all services..."
  $COMPOSE up -d
}

cmd_config() {
  local key="${1:-}"
  local value="${2:-}"

  if [ -z "$key" ]; then
    echo "Current configuration:"
    grep -v "^#" .env | grep -v "^$" | sort
    return
  fi

  if [ -z "$value" ]; then
    grep "^${key}=" .env 2>/dev/null || echo "Key not found: $key"
    return
  fi

  # Update config
  if grep -q "^${key}=" .env; then
    sed -i "s|^${key}=.*|${key}=${value}|" .env
  else
    echo "${key}=${value}" >> .env
  fi
  echo "Set ${key}=${value}"
  echo -e "${YELLOW}Restart services for changes to take effect: cairn-ctl restart${NC}"
}

cmd_admin() {
  local subcmd="${1:-}"
  shift || true

  case "$subcmd" in
    create)
      local username="${1:-}"
      local password="${2:-}"
      if [ -z "$username" ] || [ -z "$password" ]; then
        echo "Usage: cairn-ctl admin create <username> <password>"
        exit 1
      fi
      echo "Creating admin account..."
      $COMPOSE exec -T server bin/cairn eval \
        "Cairn.Release.create_admin(\"$username\", \"$password\")"
      ;;
    *)
      echo "Usage: cairn-ctl admin <create>"
      ;;
  esac
}

cmd_federation() {
  local subcmd="${1:-}"
  shift || true

  case "$subcmd" in
    list)
      $COMPOSE exec -T server bin/cairn eval \
        "Cairn.Federation.list_nodes() |> Enum.each(fn n -> IO.puts(\"\#{n.domain} [\#{n.status}]\") end)"
      ;;
    *)
      echo "Usage: cairn-ctl federation <list>"
      ;;
  esac
}

# ── Help ──

usage() {
  echo "cairn-ctl — Cairn operator CLI"
  echo ""
  echo "Usage: cairn-ctl <command> [args]"
  echo ""
  echo "Commands:"
  echo "  status              Show service status and health"
  echo "  start               Start all services"
  echo "  stop                Stop all services"
  echo "  restart             Restart all services"
  echo "  logs [service]      Follow service logs"
  echo "  upgrade             Pull latest images, migrate, restart"
  echo "  rollback            Rollback to latest backup"
  echo "  backup              Create a backup"
  echo "  restore <path>      Restore from a backup"
  echo "  config [key] [val]  View or set configuration"
  echo "  admin create <u> <p> Create an admin account"
  echo "  federation list     List federation nodes"
  echo "  help                Show this help"
}

# ── Dispatch ──

command="${1:-help}"
shift || true

case "$command" in
  status)     cmd_status ;;
  start)      cmd_start ;;
  stop)       cmd_stop ;;
  restart)    cmd_restart ;;
  logs)       cmd_logs "$@" ;;
  upgrade)    cmd_upgrade ;;
  rollback)   cmd_rollback ;;
  backup)     cmd_backup ;;
  restore)    cmd_restore "$@" ;;
  config)     cmd_config "$@" ;;
  admin)      cmd_admin "$@" ;;
  federation) cmd_federation "$@" ;;
  help|--help|-h) usage ;;
  *)
    echo -e "${RED}Unknown command: $command${NC}"
    usage
    exit 1
    ;;
esac
